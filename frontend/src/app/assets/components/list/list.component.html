<div class="row">
    <div class="col-md-3 order-md-2 text-end">
        <fingather-portfolio-selector />
    </div>
    <div class="col-md-5 order-md-0">
        <h1>Assets</h1>
    </div>
    <div class="col-md-4 order-md-1 text-end">
        <a (click)="addAsset()" class="btn btn-sm btn-success" tabindex="0"><fa-icon icon="plus"></fa-icon> Add Asset</a>
    </div>
</div>

<fingather-portfolio-total></fingather-portfolio-total>

<ul ngbNav #nav="ngbNav" [(activeId)]="activeTab" class="nav nav-tabs" role="tablist">
    <li [ngbNavItem]="'open-positions'">
        <button ngbNavLink><span class="h4">Open positions</span></button>
        <ng-template ngbNavContent>
            <div class="form-check form-switch">
                <input (change)="changeWithGroups()" class="form-check-input" type="checkbox" role="switch" id="withGroups">
                <label class="form-check-label" for="withGroups">With Groups</label>
            </div>

            @if (openedGroupedAssets !== null) {
                <div *ngFor="let group of openedGroupedAssets">
                    <table class="table table-striped">
                        <caption *ngIf="group.id !== null">{{group.name}}</caption>
                        <thead>
                            <tr>
                                <th style="width: 24%">Name</th>
                                <th style="width: 9.5%">Price</th>
                                <th style="width: 9.5%">Units</th>
                                <th style="width: 9.5%">Value</th>
                                <th style="width: 9.5%">Gain/Loss</th>
                                <th style="width: 9.5%">Dividend</th>
                                <th style="width: 9.5%">FX Impact</th>
                                <th style="width: 9.5%"><strong>Return</strong></th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let asset of group.assets">
                                <td><strong>{{asset.ticker.ticker}}</strong> {{asset.ticker.name}}</td>
                                <td class="text-end">{{asset.price | number:'1.2-2' | currency: asset.ticker.market.currencyId | async}}</td>
                                <td>{{asset.units | number:'1.0-8'}}</td>
                                <td class="text-end">{{asset.value | number:'1.2-2' | currency: defaultCurrency.id | async}}</td>
                                <td class="text-end {{asset.gain > 0 ? 'green' : (asset.gain < 0 ? 'red' : '')}}">
                                    <div class="small">{{asset.gainDefaultCurrency | number:'1.2-2' | currency: defaultCurrency.id | async}}</div>
                                    <div>{{asset.gainPercentage}}%</div>
                                </td>
                                <td class="text-end {{asset.dividendGain > 0 ? 'green' : (asset.dividendGain < 0 ? 'red' : '')}}">
                                    <div class="small">{{asset.dividendGainDefaultCurrency | number:'1.2-2' | currency: defaultCurrency.id | async}}</div>
                                    <div>{{asset.dividendGainPercentage}}%</div>
                                </td>
                                <td class="text-end {{asset.fxImpact > 0 ? 'green' : (asset.fxImpact < 0 ? 'red' : '')}}">
                                    <div class="small">{{asset.fxImpact | number:'1.2-2' | currency: defaultCurrency.id | async}}</div>
                                    <div>{{asset.fxImpactPercentage}}%</div>
                                </td>
                                <td class="text-end {{asset.return > 0 ? 'green' : (asset.return < 0 ? 'red' : '')}}">
                                    <div class="small"><strong>{{asset.return | number:'1.2-2' | currency: defaultCurrency.id | async}}</strong></div>
                                    <div><strong>{{asset.returnPercentage}}%</strong></div>
                                </td>
                            </tr>
                            <tr>
                                <td><strong>Total {{group.percentage | number:'1.2-2'}}%</strong></td>
                                <td></td>
                                <td></td>
                                <td class="text-end">{{group.groupData.value | number:'1.2-2' | currency: defaultCurrency.id | async}}</td>
                                <td class="text-end {{group.groupData.gain > 0 ? 'green' : (group.groupData.gain < 0 ? 'red' : '')}}">
                                    <div class="small">{{group.groupData.gain | number:'1.2-2' | currency: defaultCurrency.id | async}}</div>
                                    <div>{{group.groupData.gainPercentage}}%</div>
                                </td>
                                <td class="text-end {{group.groupData.dividendGain > 0 ? 'green' : (group.groupData.dividendGain < 0 ? 'red' : '')}}">
                                    <div class="small">{{group.groupData.dividendGain | number:'1.2-2' | currency: defaultCurrency.id | async}}</div>
                                    <div>{{group.groupData.dividendGainPercentage}}%</div>
                                </td>
                                <td class="text-end {{group.groupData.fxImpact > 0 ? 'green' : (group.groupData.fxImpact < 0 ? 'red' : '')}}">
                                    <div class="small">{{group.groupData.fxImpact | number:'1.2-2' | currency: defaultCurrency.id | async}}</div>
                                    <div>{{group.groupData.fxImpactPercentage}}%</div>
                                </td>
                                <td class="text-end {{group.groupData.return > 0 ? 'green' : (group.groupData.return < 0 ? 'red' : '')}}">
                                    <div class="small"><strong>{{group.groupData.return | number:'1.2-2' | currency: defaultCurrency.id | async}}</strong></div>
                                    <div><strong>{{group.groupData.returnPercentage}}%</strong></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            } @else if (openedAssets !== null) {
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th style="width: 24%">Name</th>
                            <th style="width: 9.5%">Price</th>
                            <th style="width: 9.5%">Units</th>
                            <th style="width: 9.5%">Value</th>
                            <th style="width: 9.5%">Gain/Loss</th>
                            <th style="width: 9.5%">Dividend</th>
                            <th style="width: 9.5%">FX Impact</th>
                            <th style="width: 9.5%"><strong>Return</strong></th>
                            <th style="width: 9.5%"></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let asset of openedAssets">
                            <td class="align-middle"><strong>{{asset.ticker.ticker}}</strong> {{asset.ticker.name}}</td>
                            <td class="align-middle text-end">{{asset.price | number:'1.2-2' | currency: asset.ticker.market.currencyId | async}}</td>
                            <td class="align-middle">{{asset.units | number:'1.0-8'}}</td>
                            <td class="align-middle text-end">{{asset.value | number:'1.2-2' | currency: defaultCurrency.id | async}}</td>
                            <td class="text-end {{asset.gain > 0 ? 'green' : (asset.gain < 0 ? 'red' : '')}}">
                                <div class="small">{{asset.gainDefaultCurrency | number:'1.2-2' | currency: defaultCurrency.id | async}}</div>
                                <div>{{asset.gainPercentage}}%</div>
                            </td>
                            <td class="text-end {{asset.dividendGain > 0 ? 'green' : (asset.dividendGain < 0 ? 'red' : '')}}">
                                <div class="small">{{asset.dividendGainDefaultCurrency | number:'1.2-2' | currency: defaultCurrency.id | async}}</div>
                                <div>{{asset.dividendGainPercentage}}%</div>
                            </td>
                            <td class="text-end {{asset.fxImpact > 0 ? 'green' : (asset.fxImpact < 0 ? 'red' : '')}}">
                                <div class="small">{{asset.fxImpact | number:'1.2-2' | currency: defaultCurrency.id | async}}</div>
                                <div>{{asset.fxImpactPercentage}}%</div>
                            </td>
                            <td class="text-end {{asset.return > 0 ? 'green' : (asset.return < 0 ? 'red' : '')}}">
                                <div class="small"><strong>{{asset.return | number:'1.2-2' | currency: defaultCurrency.id | async}}</strong></div>
                                <div><strong>{{asset.returnPercentage}}%</strong></div>
                            </td>
                            <td class="align-middle text-end" style="white-space: nowrap">
                                <a routerLink="{{asset.id}}" class="btn btn-sm btn-primary mr-1"><fa-icon icon="expand"></fa-icon> Detail</a>
                            </td>
                        </tr>
                    </tbody>
                </table>
            } @else {
                <span class="spinner-border spinner-border-lg align-center"></span>
            }
        </ng-template>
    </li>
    <li [ngbNavItem]="'closed-positions'">
        <button ngbNavLink><span class="h4">Closed positions</span></button>
        <ng-template ngbNavContent>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th style="width: 50%">Name</th>
                        <th style="width: 30%">Price</th>
                        <th style="width: 20%"></th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let asset of closedAssets">
                        <td class="align-middle"><strong>{{asset.ticker.ticker}}</strong> {{asset.ticker.name}}</td>
                        <td class="align-middle text-end">{{asset.price | number:'1.2-2' | currency: asset.ticker.market.currencyId | async}}</td>
                        <td class="text-end" style="white-space: nowrap">
                            <a routerLink="{{asset.id}}" class="btn btn-sm btn-primary mr-1"><fa-icon icon="expand"></fa-icon> Detail</a>
                        </td>
                    </tr>
                    <tr *ngIf="closedAssets === null">
                        <td colspan="9" class="text-center">
                            <span class="spinner-border spinner-border-lg align-center"></span>
                        </td>
                    </tr>
                </tbody>
            </table>
        </ng-template>
    </li>
    <li [ngbNavItem]="'watch-list'">
        <button ngbNavLink><span class="h4">Watch list</span></button>
        <ng-template ngbNavContent>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th style="width: 50%">Name</th>
                        <th style="width: 30%">Price</th>
                        <th style="width: 20%"></th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let asset of watchedAssets">
                        <td class="align-middle"><strong>{{asset.ticker.ticker}}</strong> {{asset.ticker.name}}</td>
                        <td class="align-middle text-end">{{asset.price | number:'1.2-2' | currency: asset.ticker.market.currencyId | async}}</td>
                        <td class="text-end" style="white-space: nowrap">
                            <a routerLink="{{asset.id}}" class="btn btn-sm btn-primary mr-1"><fa-icon icon="expand"></fa-icon> Detail</a>
                        </td>
                    </tr>
                    <tr *ngIf="watchedAssets === null">
                        <td colspan="9" class="text-center">
                            <span class="spinner-border spinner-border-lg align-center"></span>
                        </td>
                    </tr>
                </tbody>
            </table>
        </ng-template>
    </li>
</ul>

<div [ngbNavOutlet]="nav" class="mt-2"></div>
