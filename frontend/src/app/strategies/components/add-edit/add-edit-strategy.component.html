<div class="header">
    <div>
        @if (id() === null) {
            <h1 class="h3">{{ 'app.strategies.addEdit.headerAdd' | translate }}</h1>
        } @else {
            <h1 class="h3">{{ 'app.strategies.addEdit.headerEdit' | translate }}</h1>
        }

        <a [routerLink]="routerBackLink()" class="btn-link" tabindex="0">
            <mat-icon>chevron_left</mat-icon>
            {{ 'app.strategies.list.title' | translate }}
        </a>
    </div>

    <div class="header-controls d-none d-lg-block">
        <fingather-portfolio-selector />
    </div>
</div>

<div class="content-center">
    <div class="card form-wider">
        <div class="card-body">
            @if (!loading()) {
                <form [formGroup]="form" (ngSubmit)="onSubmit()">
                    <div class="mb-3">
                        <label for="name" class="form-label">{{ 'app.strategies.addEdit.name' | translate }}</label>
                        <input id="name" type="text" formControlName="name" class="form-control" [class.is-invalid]="submitted() && f['name'].errors" />
                        <fingather-input-validator
                            [control]="f['name']"
                            [isSubmitted]="submitted()"
                            [errorMessages]="{
                                required: 'app.strategies.addEdit.nameRequired',
                            }"
                        />
                    </div>
                    @if (!isFirstStrategy()) {
                        <div class="mb-3">
                            <div class="form-check">
                                <input id="isDefault" type="checkbox" formControlName="isDefault" class="form-check-input" />
                                <label for="isDefault" class="form-check-label">{{ 'app.strategies.addEdit.isDefault' | translate }}</label>
                            </div>
                        </div>
                    }

                    <div class="mb-3">
                        <span class="form-label d-block">{{ 'app.strategies.addEdit.items' | translate }}</span>

                        <div formArrayName="items" class="strategy-edit-items">
                            @for (item of items.controls; track $index) {
                                <div class="strategy-edit-item" [formGroupName]="$index">

                                    <fingather-select
                                        [id]="'type-' + $index"
                                        formControlName="type"
                                        [items]="typeItems"
                                        class="select-type"
                                    />

                                    @if (item.get('type')?.value === 'asset') {
                                        <fingather-select
                                            [id]="'assetId-' + $index"
                                            formControlName="assetId"
                                            [items]="assetItems"
                                            [placeholder]="'app.strategies.addEdit.asset' | translate"
                                        />
                                    }
                                    @if (item.get('type')?.value === 'group') {
                                        <fingather-select
                                            [id]="'groupId-' + $index"
                                            formControlName="groupId"
                                            [items]="groupItems"
                                            [placeholder]="'app.strategies.addEdit.group' | translate"
                                        />
                                    }


                                    <div class="input-group percentage">
                                        <input type="number" formControlName="percentage" class="form-control" step="0.01" min="0" max="100" />
                                        <span class="input-group-text">%</span>
                                    </div>

                                    <div>
                                        <button type="button" class="btn" (click)="removeItem($index)">
                                            <mat-icon>delete</mat-icon>
                                        </button>
                                    </div>
                                </div>
                            }
                        </div>

                        <button type="button" class="btn btn-outline-primary btn-sm mt-2" (click)="addItem()">
                            <mat-icon>add</mat-icon>
                            {{ 'app.strategies.addEdit.addItem' | translate }}
                        </button>
                    </div>

                    <div class="mb-3">
                        <strong>{{ 'app.strategies.addEdit.totalPercentage' | translate }}: {{ getTotalPercentage() }}%</strong>
                        <span class="ms-3">{{ 'app.strategies.addEdit.typeOthers' | translate }}: {{ getOthersPercentage() }}%</span>
                        @if (submitted() && getTotalPercentage() > 100) {
                            <div class="text-danger">{{ 'app.strategies.addEdit.totalMustNotExceed100' | translate }}</div>
                        }
                    </div>

                    <div class="form-group buttons">
                        <a [routerLink]="routerBackLink()" class="btn btn-secondary" tabindex="0">{{ 'app.common.cancel' | translate }}</a>

                        <fingather-save-button
                            [saving]="saving()"
                        />
                    </div>
                </form>
            }
        </div>
    </div>
</div>
